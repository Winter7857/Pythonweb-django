{% extends 'myapp/base.html' %}
{% load static %}

{% block myheader %}
<link rel="stylesheet" href="{% static 'css/myCss.css' %}">
<h1 class="display-4 text-center fw-bold my-3">Gaming Shop</h1>

<style>
  /* Home page background override: light blue + top bar */
  :root {
    --bg: #E6F2FF;      /* light blue background */
    --bg-elev: #DCEEFF; /* slightly deeper for cards */
    --accent: #93C5FD;  /* header/nav primary (blue-300) */
    --accent-2: #60A5FA;/* hover/active (blue-400) */
  }
  html, body { background-color: var(--bg); }
</style>

{% if user.is_authenticated %}
  {% with t=user.profile.usertype|default:""|lower %}
    {% if t == "vvip" %}
      <div class="alert alert-success text-center" role="alert">
        üéâ 15% Discount for VVIP members
      </div>
    {% elif t == "vip" %}
      <div class="alert alert-info text-center" role="alert">
        ‚≠ê 10% Discount for VIP members
      </div>
    {% elif t == "member" %}
      <div class="alert alert-primary text-center" role="alert">
        üëç 5% Discount for members
      </div>
    {% endif %}
  {% endwith %}
{% endif %}
{% endblock myheader %}


{% block content %}
<div class="container py-4">
  
  
  <form method="get" class="row g-2 align-items-end mb-4" role="search">
    <div class="col-12 col-md-9">
      <label for="q" class="form-label">Search games</label>
      <input type="search" id="q" name="q" class="form-control" placeholder="Search by title or description" value="{{ q|default:'' }}">
    </div>
    <div class="col-12 col-md-3 d-grid">
      <button type="submit" class="btn btn-primary">Search</button>
    </div>
  </form>

  <div class="row justify-content-center">
    {% for data in pd %}
      <div class="col-12 col-md-6 col-lg-6 mb-4">
        <div class="card h-100 shadow-sm product-card">
          {% if data.picture %}
            <div class="product-media">
              <img src="{{ data.picture.url }}" alt="{{ data.title }}" class="card-img-top product-img js-view-full" data-full-src="{{ data.picture.url }}" role="button" tabindex="0">
              <div class="view-overlay js-view-full" data-full-src="{{ data.picture.url }}" aria-label="View full image" role="button" tabindex="0">
                <span class="view-badge">üîç View</span>
              </div>
            </div>
          {% else %}
            <div class="card-img-top product-img d-flex align-items-center justify-content-center text-muted" style="font-size: 0.9rem;">No image</div>
          {% endif %}
          <div class="card-body text-center">
            <h5 class="card-title fw-bold product-title">{{ data.title }}</h5>
            {% if data.description %}
              <div class="mb-2">
                <span class="meta-badge" title="Category">{{ data.description }}</span>
              </div>
            {% endif %}
            <p class="mb-1 product-price" aria-label="Price"><span class="currency">&#3647;</span> <strong>{{ data.price|default:"0"|floatformat:2 }}</strong> <span class="unit">THB</span></p>
            {% if data.trailer_url %}
              <p class="mt-2 mb-0">
                <a href="{{ data.trailer_url }}" target="_blank" rel="noopener" class="btn btn-ghost btn-sm" aria-label="Watch trailer">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="currentColor" class="me-1" aria-hidden="true"><path d="M3 22v-20l18 10-18 10z"/></svg>
                  Watch trailer
                </a>
              </p>
            {% endif %}

            {% if not user.is_authenticated or user.profile.usertype|lower != 'admin' %}
              <button
                type="button"
                class="btn btn-primary mt-2 add-to-cart-btn"
                data-product-id="{{ data.id }}"
                data-name="{{ data.title|escapejs }}"
                data-price="{{ data.price|default:'0' }}"
                data-image="{% if data.picture %}{{ data.picture.url }}{% endif %}"
              >
                üõí Add to Cart
              </button>
            {% endif %}
          </div>
        </div>
      </div>
    {% empty %}
      <p class="text-muted text-center">No products yet.</p>
    {% endfor %}
  </div>

  {# Pagination section #}
  {% if page_obj and page_obj.paginator.num_pages > 1 %}
  <nav aria-label="Product pages" class="mt-4">
    <ul class="pagination justify-content-center">
      {% if page_obj.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?{% if q %}q={{ q|urlencode }}&{% endif %}page={{ page_obj.previous_page_number }}">Previous</a>
        </li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">Previous</span></li>
      {% endif %}

      {% for num in page_obj.paginator.page_range %}
        <li class="page-item {% if num == page_obj.number %}active{% endif %}">
          <a class="page-link" href="?{% if q %}q={{ q|urlencode }}&{% endif %}page={{ num }}">{{ num }}</a>
        </li>
      {% endfor %}

      {% if page_obj.has_next %}
        <li class="page-item">
          <a class="page-link" href="?{% if q %}q={{ q|urlencode }}&{% endif %}page={{ page_obj.next_page_number }}">Next</a>
        </li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">Next</span></li>
      {% endif %}
    </ul>
  </nav>
  {% endif %}
</div>

<style>
  .toast-host { position: fixed; right: 16px; bottom: 16px; z-index: 1080; }
  .toast-card { background: var(--bg-elev); color: var(--text); border: 1px solid var(--border); border-radius: .5rem; padding: .6rem .9rem; min-width: 240px; box-shadow: 0 10px 30px rgba(0,0,0,.35); }
  .toast-card + .toast-card { background: var(--bg-elev); color: var(--text); border: 1px solid var(--border); border-radius: .5rem; padding: .6rem .9rem; min-width: 240px; box-shadow: 0 10px 30px rgba(0,0,0,.35); }

  /* Cool gradient/glass product card */
  .product-card {
    position: relative;
    border-radius: 1rem;
    border: 1px solid transparent;
    background: linear-gradient(180deg, rgba(255,255,255,.88), rgba(255,255,255,.96)) padding-box,
                radial-gradient(120% 120% at 0% 0%, rgba(96,165,250,.65), rgba(197,186,255,.55)) border-box;
    box-shadow: 0 8px 26px rgba(15,23,42,.08), 0 2px 10px rgba(15,23,42,.06);
    transition: transform .22s ease, box-shadow .22s ease, filter .22s ease;
    overflow: hidden;
  }
  .product-card::after {
    content: '';
    position: absolute; inset: 0; pointer-events: none;
    border-radius: inherit;
    background: radial-gradient(60% 60% at 20% 0%, rgba(255,255,255,.35), transparent 60%);
    mix-blend-mode: soft-light;
  }
  .product-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 18px 42px rgba(15,23,42,.16), 0 8px 18px rgba(15,23,42,.10);
    filter: saturate(1.06);
  }

  .product-media { position: relative; overflow: hidden; border-top-left-radius: 1rem; border-top-right-radius: 1rem; }
  .product-img {
    width: 100%; aspect-ratio: 16/9; height: auto;
    object-fit: cover; background: var(--bg-elev); display: block; cursor: zoom-in;
    transition: transform .35s ease, filter .2s ease;
    will-change: transform;
  }
  .product-card:hover .product-img { transform: scale(1.04); filter: contrast(1.02) saturate(1.03); }

  .view-overlay { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity .2s ease-in-out, backdrop-filter .2s ease-in-out; background: linear-gradient(180deg, rgba(0,0,0,.12), rgba(0,0,0,.28)); z-index: 2; backdrop-filter: blur(0px); }
  .product-media:hover .view-overlay, .product-media:focus-within .view-overlay { opacity: 1; backdrop-filter: blur(1.5px); }
  .view-badge { background: rgba(0,0,0,.55); color: #fff; padding: .3rem .7rem; border-radius: 9999px; font-weight: 700; font-size: .9rem; transform: translateY(2px); transition: transform .2s ease; letter-spacing: .01em; }
  .product-media:hover .view-badge, .product-media:focus-within .view-badge { transform: translateY(0); }

  .product-title { min-height: 2.4em; font-size: 1.2rem; line-height: 1.25; }
  @media (min-width: 768px) { .product-title { font-size: 1.35rem; } }

  /* Smoother button look */
  .btn.add-to-cart-btn { min-width: 180px; border-radius: 9999px; padding: .55rem 1.1rem; transition: transform .15s ease, box-shadow .15s ease; font-weight: 800; letter-spacing: .01em; }
  .btn.add-to-cart-btn:hover { transform: translateY(-1px); box-shadow: 0 8px 18px rgba(96,165,250,.25); }
  .btn.add-to-cart-btn:active { transform: translateY(0); box-shadow: 0 2px 8px rgba(0,0,0,.12); }
  .btn.add-to-cart-btn:focus-visible { outline: 2px solid rgba(96,165,250,.6); outline-offset: 2px; }

  /* Ghost button for trailer */
  .btn-ghost { 
    color: #0b5ed7; border: 1px solid rgba(96,165,250,.55); 
    background: rgba(96,165,250,.10);
    border-radius: 10rem; font-weight: 700; 
    transition: transform .15s ease, box-shadow .15s ease, background-color .15s ease;
    backdrop-filter: blur(2px);
  }
  .btn-ghost:hover { 
    background: rgba(96,165,250,.18); 
    box-shadow: 0 6px 16px rgba(96,165,250,.25);
    transform: translateY(-1px);
  }
  .btn-ghost:active { transform: translateY(0); }

  /* Product card text follows theme text color */
  .product-card, .product-card .card-title, .product-card .product-price, .product-card p,
  .product-card .text-muted, .product-card small, .product-card a, .product-card strong {
    color: var(--text) !important;
  }

  /* Professional text accents and emphasis */
  .meta-badge { display: inline-block; padding: .35rem .7rem; border-radius: 9999px; background: rgba(196,217,255,.35); border: 1px solid var(--border); color: var(--muted); font-weight: 700; font-size: .82rem; letter-spacing: .02em; }
  .product-price { 
    display: inline-flex; align-items: center; gap: .25rem;
    font-size: 1.05rem; 
    padding: .35rem .8rem; border-radius: 9999px; 
    background: rgba(96,165,250,.12); border: 1px solid rgba(96,165,250,.35);
  }
  .product-price .currency { color: var(--muted); margin-right: .15rem; }
  .product-price .unit { color: var(--muted); margin-left: .25rem; font-weight: 700; letter-spacing: .02em; }
  .product-card .product-price strong { font-size: 1.45rem; color: #0b0b0b !important; font-weight: 900; }
</style>

<!-- Image Modal -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content" style="background: transparent; border: 0;">
      <button type="button" class="btn-close ms-auto me-2 mt-2" data-bs-dismiss="modal" aria-label="Close"></button>
      <img id="imageModalImg" src="" alt="" class="img-fluid rounded shadow" style="display:block;">
    </div>
  </div>
  
</div>

<div id="toast-root" class="toast-host"></div>

<script>
  (function () {
    const toastRoot = document.getElementById('toast-root');
    const imageModalEl = document.getElementById('imageModal');
    const imageModalImg = document.getElementById('imageModalImg');
    let imageModal;
    function getImageModal() {
      if (!imageModalEl) return null;
      // Create lazily so Bootstrap can load first
      if (!imageModal && window.bootstrap && typeof window.bootstrap.Modal === 'function') {
        imageModal = new window.bootstrap.Modal(imageModalEl);
      }
      return imageModal || null;
    }
    function showToast(message, opts) {
      const duration = (opts && opts.duration) || 1800;
      const icon = (opts && opts.icon) || '';
      const el = document.createElement('div');
      el.className = 'toast-card';
      el.innerHTML = `<div>${icon ? `<span class=\"me-2\">${icon}</span>` : ''}${message}</div>`;
      toastRoot.appendChild(el);
      setTimeout(() => el.remove(), duration);
    }

    function readCart() {
      try {
        const raw = localStorage.getItem('cart');
        return raw ? JSON.parse(raw) : [];
      } catch (_) { return []; }
    }
    function saveCart(items) {
      localStorage.setItem('cart', JSON.stringify(items || []));
    }
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }

    async function addToServerCart(productId) {
      try {
        const res = await fetch('/api/cart/add/', {
          method: 'POST',
          credentials: 'same-origin',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken') || ''
          },
          body: new URLSearchParams({ product_id: String(productId) })
        });
        return res.ok;
      } catch (_) {
        return false;
      }
    }

    function onAddClick(btn) {
      const id = btn.getAttribute('data-product-id');
      const name = btn.getAttribute('data-name') || '';
      const price = Number(btn.getAttribute('data-price') || '0');
      const image = btn.getAttribute('data-image') || '';

      const cart = readCart();
      if (!cart.some(g => String(g.id) === String(id))) {
        cart.push({ id: String(id), name, price, image });
        saveCart(cart);
      }
      showToast('Added to cart', { icon: 'üõí', duration: 1500 });
      // Fire-and-forget server sync for logged-in users
      addToServerCart(id);
    }

    document.addEventListener('click', function (e) {
      const target = e.target.closest('.add-to-cart-btn');
      if (target) {
        e.preventDefault();
        onAddClick(target);
      }
      const imgEl = e.target.closest('.js-view-full');
      if (imgEl && imageModalImg) {
        e.preventDefault();
        const full = imgEl.getAttribute('data-full-src') || imgEl.getAttribute('src');
        imageModalImg.src = full || '';
        imageModalImg.alt = imgEl.getAttribute('alt') || 'Product image';
        const modal = getImageModal();
        if (modal) {
          modal.show();
        } else if (full) {
          // Fallback: open in new tab if Bootstrap not loaded yet
          window.open(full, '_blank');
        }
      }
    });

    document.addEventListener('keydown', function (e) {
      if ((e.key === 'Enter' || e.key === ' ') && document.activeElement && document.activeElement.classList && document.activeElement.classList.contains('js-view-full')) {
        e.preventDefault();
        const imgEl = document.activeElement;
        if (imageModalImg) {
          const full = imgEl.getAttribute('data-full-src') || imgEl.getAttribute('src');
          imageModalImg.src = full || '';
          imageModalImg.alt = imgEl.getAttribute('alt') || 'Product image';
          const modal = getImageModal();
          if (modal) {
            modal.show();
          } else if (full) {
            window.open(full, '_blank');
          }
        }
      }
    });
  })();
</script>

{# Footer now provided by base.html only on home-page #}

<script src="{% static 'js/myJS.js' %}"></script>
{% endblock content %}



