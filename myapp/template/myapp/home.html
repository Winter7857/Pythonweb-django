{% extends 'myapp/base.html' %}
{% load static %}

{% block myheader %}
<link rel="stylesheet" href="{% static 'css/myCss.css' %}">
<h1 class="display-4 text-center fw-bold my-3">CoC Gaming Shop</h1>

{% if user.is_authenticated %}
  {% with t=user.profile.usertype|default:""|lower %}
    {% if t == "vvip" %}
      <div class="alert alert-success text-center" role="alert">
        üéâ 15% Discount for VVIP members
      </div>
    {% elif t == "vip" %}
      <div class="alert alert-info text-center" role="alert">
        ‚≠ê 10% Discount for VIP members
      </div>
    {% elif t == "member" %}
      <div class="alert alert-primary text-center" role="alert">
        üëç 5% Discount for members
      </div>
    {% endif %}
  {% endwith %}
{% endif %}
{% endblock myheader %}


{% block content %}
<div class="container py-4">
  <h2 class="text-center mb-3">Welcome to My Django App</h2>

  <div class="row justify-content-center">
    {% for data in pd %}
      <div class="col-12 col-md-6 col-lg-6 mb-4">
        <div class="card h-100 shadow-sm product-card">
          {% if data.picture %}
            <div class="product-media">
              <img src="{{ data.picture.url }}" alt="{{ data.title }}" class="card-img-top product-img js-view-full" data-full-src="{{ data.picture.url }}" role="button" tabindex="0">
              <div class="view-overlay js-view-full" data-full-src="{{ data.picture.url }}" aria-label="View full image" role="button" tabindex="0">
                <span class="view-badge">üîç View</span>
              </div>
            </div>
          {% else %}
            <div class="card-img-top product-img d-flex align-items-center justify-content-center text-muted" style="font-size: 0.9rem;">No image</div>
          {% endif %}
          <div class="card-body text-center">
            <h5 class="card-title fw-bold product-title">{{ data.title }}</h5>
            <p class="text-muted small mb-1">{{ data.description }}</p>
            <p class="mb-1 product-price">üí∞ <strong>{{ data.price|default:"0"|floatformat:2 }}</strong> THB</p>
            <p class="mb-1">üì¶ Stock: {{ data.quantity|default:0 }}</p>

            {% if data.specfile %}
              <p class="mt-2">
                üìÅ Spec file:
                <a href="{{ data.specfile.url }}" download class="text-decoration-none text-primary">
                  Download
                </a>
              </p>
            {% endif %}

            {% if not user.is_authenticated or user.profile.usertype|lower != 'admin' %}
              <button
                type="button"
                class="btn btn-primary mt-2 add-to-cart-btn"
                data-product-id="{{ data.id }}"
                data-name="{{ data.title|escapejs }}"
                data-price="{{ data.price|default:'0' }}"
                data-image="{% if data.picture %}{{ data.picture.url }}{% endif %}"
              >
                üõí Add to Cart
              </button>
            {% endif %}
          </div>
        </div>
      </div>
    {% empty %}
      <p class="text-muted text-center">No products yet.</p>
    {% endfor %}
  </div>

  {# Pagination section #}
  {% if page_obj and page_obj.paginator.num_pages > 1 %}
  <nav aria-label="Product pages" class="mt-4">
    <ul class="pagination justify-content-center">
      {% if page_obj.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?page={{ page_obj.previous_page_number }}">Previous</a>
        </li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">Previous</span></li>
      {% endif %}

      {% for num in page_obj.paginator.page_range %}
        <li class="page-item {% if num == page_obj.number %}active{% endif %}">
          <a class="page-link" href="?page={{ num }}">{{ num }}</a>
        </li>
      {% endfor %}

      {% if page_obj.has_next %}
        <li class="page-item">
          <a class="page-link" href="?page={{ page_obj.next_page_number }}">Next</a>
        </li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">Next</span></li>
      {% endif %}
    </ul>
  </nav>
  {% endif %}
</div>

<style>
  .toast-host { position: fixed; right: 16px; bottom: 16px; z-index: 1080; }
  .toast-card { background: var(--bg-elev); color: var(--text); border: 1px solid var(--border); border-radius: .5rem; padding: .6rem .9rem; min-width: 240px; box-shadow: 0 10px 30px rgba(0,0,0,.35); }
  .toast-card + .toast-card { background: var(--bg-elev); color: var(--text); border: 1px solid var(--border); border-radius: .5rem; padding: .6rem .9rem; min-width: 240px; box-shadow: 0 10px 30px rgba(0,0,0,.35); }
  .btn.add-to-cart-btn { min-width: 160px; }
  .product-media { position: relative; }
  .product-img { width: 100%; aspect-ratio: 16/9; height: auto; object-fit: cover; background: var(--bg-elev); display: block; cursor: zoom-in; }
  .view-overlay { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity .18s ease-in-out; background: rgba(0,0,0,.25); z-index: 2; }
  .view-badge { background: rgba(0,0,0,.55); color: #fff; padding: .25rem .6rem; border-radius: 9999px; font-weight: 600; font-size: .9rem; }
  .product-media:hover .view-overlay, .product-media:focus-within .view-overlay { opacity: 1; }
  .product-card { border-radius: .75rem; }
  .product-title { min-height: 2.4em; }
    /* Product card text follows theme text color */
  .product-card, .product-card .card-title, .product-card .product-price, .product-card p,
  .product-card .text-muted, .product-card small, .product-card a, .product-card strong {
    color: var(--text) !important;
  }
</style>

<!-- Image Modal -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content" style="background: transparent; border: 0;">
      <button type="button" class="btn-close ms-auto me-2 mt-2" data-bs-dismiss="modal" aria-label="Close"></button>
      <img id="imageModalImg" src="" alt="" class="img-fluid rounded shadow" style="display:block;">
    </div>
  </div>
  
</div>

<div id="toast-root" class="toast-host"></div>

<script>
  (function () {
    const toastRoot = document.getElementById('toast-root');
    const imageModalEl = document.getElementById('imageModal');
    const imageModalImg = document.getElementById('imageModalImg');
    let imageModal;
    function getImageModal() {
      if (!imageModalEl) return null;
      // Create lazily so Bootstrap can load first
      if (!imageModal && window.bootstrap && typeof window.bootstrap.Modal === 'function') {
        imageModal = new window.bootstrap.Modal(imageModalEl);
      }
      return imageModal || null;
    }
    function showToast(message, opts) {
      const duration = (opts && opts.duration) || 1800;
      const icon = (opts && opts.icon) || '';
      const el = document.createElement('div');
      el.className = 'toast-card';
      el.innerHTML = `<div>${icon ? `<span class=\"me-2\">${icon}</span>` : ''}${message}</div>`;
      toastRoot.appendChild(el);
      setTimeout(() => el.remove(), duration);
    }

    function readCart() {
      try {
        const raw = localStorage.getItem('cart');
        return raw ? JSON.parse(raw) : [];
      } catch (_) { return []; }
    }
    function saveCart(items) {
      localStorage.setItem('cart', JSON.stringify(items || []));
    }
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }

    async function addToServerCart(productId) {
      try {
        const res = await fetch('/api/cart/add/', {
          method: 'POST',
          credentials: 'same-origin',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken') || ''
          },
          body: new URLSearchParams({ product_id: String(productId) })
        });
        return res.ok;
      } catch (_) {
        return false;
      }
    }

    function onAddClick(btn) {
      const id = btn.getAttribute('data-product-id');
      const name = btn.getAttribute('data-name') || '';
      const price = Number(btn.getAttribute('data-price') || '0');
      const image = btn.getAttribute('data-image') || '';

      const cart = readCart();
      if (!cart.some(g => String(g.id) === String(id))) {
        cart.push({ id: String(id), name, price, image });
        saveCart(cart);
      }
      showToast('Added to cart', { icon: 'üõí', duration: 1500 });
      // Fire-and-forget server sync for logged-in users
      addToServerCart(id);
    }

    document.addEventListener('click', function (e) {
      const target = e.target.closest('.add-to-cart-btn');
      if (target) {
        e.preventDefault();
        onAddClick(target);
      }
      const imgEl = e.target.closest('.js-view-full');
      if (imgEl && imageModalImg) {
        e.preventDefault();
        const full = imgEl.getAttribute('data-full-src') || imgEl.getAttribute('src');
        imageModalImg.src = full || '';
        imageModalImg.alt = imgEl.getAttribute('alt') || 'Product image';
        const modal = getImageModal();
        if (modal) {
          modal.show();
        } else if (full) {
          // Fallback: open in new tab if Bootstrap not loaded yet
          window.open(full, '_blank');
        }
      }
    });

    document.addEventListener('keydown', function (e) {
      if ((e.key === 'Enter' || e.key === ' ') && document.activeElement && document.activeElement.classList && document.activeElement.classList.contains('js-view-full')) {
        e.preventDefault();
        const imgEl = document.activeElement;
        if (imageModalImg) {
          const full = imgEl.getAttribute('data-full-src') || imgEl.getAttribute('src');
          imageModalImg.src = full || '';
          imageModalImg.alt = imgEl.getAttribute('alt') || 'Product image';
          const modal = getImageModal();
          if (modal) {
            modal.show();
          } else if (full) {
            window.open(full, '_blank');
          }
        }
      }
    });
  })();
</script>

<script src="{% static 'js/myJS.js' %}"></script>
{% endblock content %}



