{% extends 'myapp/base.html' %}
{% load static %}

{% block myheader %}
<link rel="stylesheet" href="{% static 'css/myCss.css' %}">
<h1 class="display-4 text-center fw-bold my-3">CoC Gaming Shop</h1>

{% if user.is_authenticated %}
  {% with t=user.profile.usertype|default:""|lower %}
    {% if t == "vvip" %}
      <div class="alert alert-success text-center" role="alert">
        üéâ 15% Discount for VVIP members
      </div>
    {% elif t == "vip" %}
      <div class="alert alert-info text-center" role="alert">
        ‚≠ê 10% Discount for VIP members
      </div>
    {% elif t == "member" %}
      <div class="alert alert-primary text-center" role="alert">
        üëç 5% Discount for members
      </div>
    {% endif %}
  {% endwith %}
{% endif %}
{% endblock myheader %}


{% block content %}
<div class="container py-4">
  <h2 class="text-center mb-3">Welcome to My Django App</h2>
  <p class="text-center text-muted">This is the home page of my Django application.</p>

  <div class="row justify-content-center">
    {% for data in pd %}
      <div class="col-12 col-md-6 col-lg-6 mb-4">
        <div class="card h-100 shadow-sm product-card">
          {% if data.picture %}
            <img src="{{ data.picture.url }}" alt="{{ data.title }}" class="card-img-top product-img">
          {% endif %}
          <div class="card-body text-center">
            <h5 class="card-title fw-bold product-title">{{ data.title }}</h5>
            <p class="text-muted small mb-1">{{ data.description }}</p>
            <p class="mb-1 product-price">üí∞ <strong>{{ data.price|default:"0"|floatformat:2 }}</strong> THB</p>
            <p class="mb-1">üì¶ Stock: {{ data.quantity|default:0 }}</p>

            {% if data.specfile %}
              <p class="mt-2">
                üìÅ Spec file:
                <a href="{{ data.specfile.url }}" download class="text-decoration-none text-primary">
                  Download
                </a>
              </p>
            {% endif %}

            {% if not user.is_authenticated or user.profile.usertype|lower != 'admin' %}
              <button
                type="button"
                class="btn btn-primary mt-2 add-to-cart-btn"
                data-product-id="{{ data.id }}"
                data-name="{{ data.title|escapejs }}"
                data-price="{{ data.price|default:'0' }}"
                data-image="{% if data.picture %}{{ data.picture.url }}{% endif %}"
              >
                üõí Add to Cart
              </button>
            {% endif %}
          </div>
        </div>
      </div>
    {% empty %}
      <p class="text-muted text-center">No products yet.</p>
    {% endfor %}
  </div>

  {# Pagination section #}
  {% if page_obj and page_obj.paginator.num_pages > 1 %}
  <nav aria-label="Product pages" class="mt-4">
    <ul class="pagination justify-content-center">
      {% if page_obj.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?page={{ page_obj.previous_page_number }}">Previous</a>
        </li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">Previous</span></li>
      {% endif %}

      {% for num in page_obj.paginator.page_range %}
        <li class="page-item {% if num == page_obj.number %}active{% endif %}">
          <a class="page-link" href="?page={{ num }}">{{ num }}</a>
        </li>
      {% endfor %}

      {% if page_obj.has_next %}
        <li class="page-item">
          <a class="page-link" href="?page={{ page_obj.next_page_number }}">Next</a>
        </li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">Next</span></li>
      {% endif %}
    </ul>
  </nav>
  {% endif %}
</div>

<style>
  .toast-host { position: fixed; right: 16px; bottom: 16px; z-index: 1080; }
  .toast-card { background: #1e293b; color: #fff; border-radius: .5rem; padding: .6rem .9rem; min-width: 240px; box-shadow: 0 10px 30px rgba(0,0,0,.35); }
  .toast-card + .toast-card { margin-top: .5rem; }
  .btn.add-to-cart-btn { min-width: 160px; }
  .product-img { object-fit: cover; max-height: 320px; }
  .product-card { border-radius: .75rem; }
  .product-title { min-height: 2.4em; }
</style>

<div id="toast-root" class="toast-host"></div>

<script>
  (function () {
    const toastRoot = document.getElementById('toast-root');
    function showToast(message, opts) {
      const duration = (opts && opts.duration) || 1800;
      const icon = (opts && opts.icon) || '';
      const el = document.createElement('div');
      el.className = 'toast-card';
      el.innerHTML = `<div>${icon ? `<span class=\"me-2\">${icon}</span>` : ''}${message}</div>`;
      toastRoot.appendChild(el);
      setTimeout(() => el.remove(), duration);
    }

    function readCart() {
      try {
        const raw = localStorage.getItem('cart');
        return raw ? JSON.parse(raw) : [];
      } catch (_) { return []; }
    }
    function saveCart(items) {
      localStorage.setItem('cart', JSON.stringify(items || []));
    }
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }

    async function addToServerCart(productId) {
      try {
        const res = await fetch('/api/cart/add/', {
          method: 'POST',
          credentials: 'same-origin',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken') || ''
          },
          body: new URLSearchParams({ product_id: String(productId) })
        });
        return res.ok;
      } catch (_) {
        return false;
      }
    }

    function onAddClick(btn) {
      const id = btn.getAttribute('data-product-id');
      const name = btn.getAttribute('data-name') || '';
      const price = Number(btn.getAttribute('data-price') || '0');
      const image = btn.getAttribute('data-image') || '';

      const cart = readCart();
      if (!cart.some(g => String(g.id) === String(id))) {
        cart.push({ id: String(id), name, price, image });
        saveCart(cart);
      }
      showToast('Added to cart', { icon: 'üõí', duration: 1500 });
      // Fire-and-forget server sync for logged-in users
      addToServerCart(id);
    }

    document.addEventListener('click', function (e) {
      const target = e.target.closest('.add-to-cart-btn');
      if (target) {
        e.preventDefault();
        onAddClick(target);
      }
    });
  })();
</script>

<script src="{% static 'js/myJS.js' %}"></script>
{% endblock content %}
